
4.1 USB初始化过程
	USB驱动作为一个系统，集成了众多的驱动模块，注册过程非常复杂。从USB系统角度
	来说，USB主机驱动主要包含：
	1）USB核驱动
	2）主机控制器驱动
	3）集线器驱动

	驱动的加载流程如下图所示:
	 
 	message.c  usb_control_msg()

#---------------------------------------------------------------------#
	 usb_get_device_descriptor()
	 usb_hcd_pool_rh_status()

	Hcd.c
	 hcd_buffer_create
	 usb_register_bus
	 usb_alloc_dev
	  
	 usb_hcd_poll_rh_status
	 usb_get_device_descriptor
	 register_root_hub

	otgip_ehci 
	 otg_ip_irq()
	 usb_add_hcd()
	 usb_create_hcd()


	platform_get_resource();
	platform_get_irq();

	otg_probe()

											usb_get_device_state()					
											usb_new_device()
											device_add()
											hub_port_init()
											usb_hub_port_init()
											usb_hub_port_change()
											hub_port_change()
											hub_port_status()
											hub_prereset()
											usb_autopm_get_interface()
											hub_event()
											kthread_run()
#---------------------------------------------------------------------#
	usb/core/usb.c
	usb_init()       usb_host_init()  usb_hub_init() usb_dev_init()

#---------------------------------------------------------------------#
4.1.1 USB Core的初始化
	USB驱动从USB子系统的初始化开始，USB子系统的初始化在文件driver/usb/core/usb.c
	1.subsys_initcall(usb_init);
	2.module_exit(usb_exit);
	subsys_initcall()是一个宏，可以理解为module_init().由于此部分代码非常重要
	开发者把它看作一个子系统,而不仅仅是一个模块。USB Core这个模块代表的不是某
	一个设备，而是所有USB设备赖以生存的模块。在Linux中，像这样一个类别的设备
	驱动被归结为一个子系统。

	subsys_initcall(usb_init)告诉我们，usb_init才是真正的初始化函数，而usb_exit
	将整个USB子系统结束时的清理函数。

4.1.2 主机控制器的初始化及驱动执行(以EHCI为例)
	module_init(otg_init);											模块注册
	static init __init otg_init(void);
	platform_driver_register();										平台注册. 
	static  init __init otg_probe(struct platform_device *pdev);    探测处理函数

	reg = platform_get_resource(pdev, IORESOURCE_MEM, 0);           获取寄存器信息
	data = platform_get_resource(pdev, IORESOURCE_MEM,1);           获取内存信息

	irq = platform_get_irq(pdev, 0);                                获取中断号
	usb_create_hcd(&otg_hc_driver, &pdej据空间进行分配，初始化计数,总线，定时器，
	HCD结构体各成员值 

	ret = usb_add_hcd(hcd, irq, SA_INTERRUPT);
	完成HCD结构体的初始化和注册，申请buffer，注册总线，分配设备端内存空间，向
	中断向量表中申请中断，注册根集线器，对根集线器状态进行轮询


4.1.3 注册集线器
	register_root_hub(hcd);
	在USB系统驱动加载过程中,创建了集线器的线程(khubd),并且一直查询相应的线程
	事务。HCD驱动中，将集线器作为一个设备添加到主机控制器驱动中，然后进行集线器
	端口的初始化。在USB主机看来，根集线器本身也是USB主机的设备。USB主机驱动加载
	完成之后，即开始注册根集线器，并且作为一个设备加载到主机驱动之中。

	USB主机和USB设备之间进行数据交互，USB设备本身并没有总线控制权，u盘被动地
	接收USB主机发送过来的信息并做响应。USB主机控制器与根集线器构成了主机系统，
	然后外接其它的USB设备。

	为了更好地探测到根集线器的状态变化，USB主机控制器驱动增加了状态轮询函数。
	以一定的时间间隔轮询根集线器状态是否发生变化。一旦根集线器状态发生变化
	主机控制器就会产生相应的响应。

	USB和USB设备之间的数据传输以URB(USB Request Block)的形式进行。

4.2 URB传输过程
	usb初始化过程中，无论是主机控制器驱动还是根集线器驱动，都是通过URB传输设备
	信息。

4.2.1  申请URB
	struct urb *usb_alloc_urb(int iso_packets, gfp_t mem_flags)
	为urb分配内存并执行初始化。

4.2.2 初始化URB
	
 static inline void_fill_bulk_urb(struct urb *urb,
		 struct usb_device *dev,
		 unsigned int pipe,
		 void *transfer_buffer,
		 int buffer_length,
		 usb_complete_t complete_fn,
		 void *context)


 static inline void usb_fill_control_urb(struct urb *urb,
		 struct usb_device *dev,
		 unsigned int pipe,
		 unsigned char *setup_packet,
		 void *transfer_buffer,
		 int buffer_length,
		 usb_complete_t complete_fn,
		 void *context)

 static inline void usb_fill_int_urb(struct urb *urb,)
		 struct usb_device *dev,
		 unsigned int pipe,
		 void *transfer_buffer,
		 int buffer_length,
		 usb_complete_t complete_fn,
		 void *context,
		 int interval
		 )

		 不同的传输模式下，驱动为之申请不同URB。其中，Linux内核只支持同步传输外
的三种传输事件，ISO事务需要手工进行初始化工作。控制传输事务，批量传输事务，中断
传输事务API如上所示。
	三种事务传输模式下的URB初始化函数有很多相似之处，主要参数含义如下：
	*urb：事务传输中的urb
	*dev：事务传输的目的设备
	*pipe：USB主机与USB设备之间数据传输的通道
	*transfer_buffer: 发送数据所申请的内存缓冲的设备数据包
	*usb_fill_int_urb()的interval:中断传输中两个URB调度的时间间隔


4.2.3 提交URB
	URB初始化完成之后，USBD开始通过usb_start_wait_urb()提交urb请求
	(它调用usb_submit_urb来真正发送URB请求),添加completition函数。

	接下来，从message.c传到主机控制器hcd.c，开始真正的usb_hcd_submit_urb()。
	此时，根据是否为根集线器，进入不同的工作队列。
	usb_start_wait_urb->
	usb_submit_urb    ->
	usb_hcd_submit_urb_>

	a)root_hub传输
	若为root hub，将调用rh_urb_enqueue(),共有两种传输事务(控制传输和中断传输)


	static int rh_urb_enqueue(struct usb_hcd *hcd, struct urb *urb)
	{
		if(usb_endpoint_xfer_int(&urb->ep->desc))
			return rh_queue_status(hcd, urb);

		if(usb_endpoint_xfer_control(&urb->ep->desc))
			return rh_call_control(hcd, urb);
	}





	b)非root_hub传输
	对于非常root_hub传输，它调用：
	status = hcd->driver->urb_enqueue(hcd, urb, mem_flags)



	C)批量传输
	root_hub本身没有批量传输流程，按照控制传输流程，控制传输最终要通过switch
	语句跳转到bulk-only传输流程中。


1.1 USB子系统结构
	用户

	Block Net Char
	USB设备驱动
	USB Core
	USB主机控制器

	协议里说，HCD提供主控制器驱动硬件抽象，它只对USB Core一个负责，USB Core将
	用户的请求映射到相关HCD，用户不能直接访问HCD。换句话说，USB Core就HCD与USB
	设备唯一的桥梁。


1.2 USB子系统的初始化
	usbcore这个模块代表的不是某一个设备，而是所有USB设备赖以生存的模块,它就是
	USB子系统。

	
	./driver/usb/core/usb.c里实现了初始化，伪代码如下

static int __init usb_init(void)
{
	usb_debugfs_init();
	bus_register(&usb_bus_type);
	bus_register_notifier(&usb_bus_type, &usb_bus_nb);
	usb_major_init();
	usb_register(&usbfs_driver);
	usb_devio_init();
	usbfs_init();
	usb_hub_init();
	usb_register_device_driver(&usb_generic_driver, THIS_MODULE);
}

	usbcore注册了USB总线，USB文件系统，USB Hub以及USB的设备驱动usb generic 
	driver等。


1.3 USB总线
	注册总线通过bus_register(&usb_bus_type);
	下面总结USB设备和驱动匹配的过程，
	-> step 1 - usb device driver
						USB总线

						|
						|
						|-----------usb_generic_driver(usb device driver)
						|
						|
						|
						|


	USB子系统初始化的时候就会注册usb_generic_driver,它的结构体类型是
	usb_device_driver,它是usb世界里唯一的一个USB设备驱动，区别于struct
	usb_driver USB驱动。
	*USB设备驱动(usb device driver)就只有一个,usb_generice_driver这个
	对象，所有USB设备都要绑定到usb_generic_driver上，它的使命可以概括
	为：为USB设备选择一个合适的配置，让设备进入configured状态。

	USB驱动(usb driver)就是USb设备的接口驱动程序，比如adb驱动程序，u盘
	驱动程序，鼠标驱动程序等等。


	-> step 2 - usb driver


						USB总线

						|
						|
						|-----------usb_generic_driver)
						|              (usb device driver)
						|
						|-----------usb驱动链表
						|              (usb driver)
						|           adb
						|           mouse
						|           keyboard
						|           usb mass storage
						|           ... ...

	Linux启动时注册USB驱动,在xxx_init()里通过usb_register()将USB驱动提交
	个设备模型，添加到USB总线驱动链表里。

	-> step 3 - usb device

						USB总线

						|
						|
						|-----------usb_generic_driver)
		usb设备链表		|              (usb device driver)
			手机     	|
		    U盘			|-----------usb驱动链表
						|              (usb driver)
						|           adb
						|           mouse
						|           keyboard
						|           usb mass storage
						|           ... ...



